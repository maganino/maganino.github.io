---
/**
 * BLOG PAGE
 * 
 * Displays all blog posts from the content collection
 * Features:
 * - Chronological sorting (newest first)
 * - Tag filtering
 * - Hero images
 * - Reading time estimate
 */

import Layout from '../../layouts/Layout.astro'
import { getCollection } from 'astro:content'

// Get all blog posts, filter out drafts, sort by date
const allPosts = await getCollection('blog')
const posts = allPosts
  .filter(post => !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())

// Extract all unique tags
const allTags = [...new Set(posts.flatMap(post => post.data.tags))]

const drawings = {
  lighthouse: {
    light: '/images/drawings/inverted/lighthouse.png',
    dark: '/images/drawings/transparent/lighthouse.png'
  },
  spiralsColorful: {
    light: '/images/drawings/inverted/spirals-colorful.png',
    dark: '/images/drawings/transparent/spirals-colorful.png'
  }
}

// Helper function to estimate reading time
function getReadingTime(content: string): string {
  const wordsPerMinute = 200
  const wordCount = content.split(/\s+/).length
  const minutes = Math.ceil(wordCount / wordsPerMinute)
  return `${minutes} min read`
}
---

<Layout title="Blog | Mina Mounir">
  <main class="pt-24">
    
    <!-- ============================================
         HERO SECTION
         ============================================ -->
    <section class="py-16 px-6 relative overflow-hidden" style="background-color: var(--bg);">
      
      <!-- Background texture -->
      <img 
        src={drawings.lighthouse.dark}
        alt="" 
        class="absolute top-0 left-0 w-96 h-96 object-contain opacity-10 pointer-events-none only-dark"
        aria-hidden="true"
      />
      <img 
        src={drawings.lighthouse.light}
        alt="" 
        class="absolute top-0 left-0 w-96 h-96 object-contain opacity-10 pointer-events-none only-light"
        aria-hidden="true"
      />
      
      <div class="max-w-6xl mx-auto relative z-10">
        <h1 class="font-chalk text-6xl md:text-8xl font-bold mb-6" style="color: var(--text);">
          Blog
        </h1>
        <p class="text-xl max-w-2xl" style="color: var(--muted);">
          Thoughts on innovation, dialogue, visual thinking, and bridging worlds.
        </p>
      </div>
    </section>

    <!-- ============================================
         TAG FILTERS
         ============================================ -->
    {allTags.length > 0 && (
      <section class="py-8 px-6 sticky top-20 z-40" style="background-color: var(--surface);">
        <div class="max-w-6xl mx-auto">
          <div class="flex flex-wrap gap-3 justify-center">
            <button 
              class="tag-filter active px-4 py-2 rounded-full text-sm font-medium transition-all"
              data-tag="all"
              style="background-color: var(--accent-primary); color: white;"
            >
              All Posts
            </button>
            {allTags.map((tag) => (
              <button 
                class="tag-filter px-4 py-2 rounded-full text-sm font-medium transition-all"
                data-tag={tag}
                style="background-color: var(--bg); color: var(--text);"
              >
                {tag}
              </button>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- ============================================
         BLOG POSTS GRID
         ============================================ -->
    <section class="py-16 px-6" style="background-color: var(--bg);">
      <div class="max-w-6xl mx-auto">
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
          
          {posts.map((post) => {
            const readingTime = getReadingTime(post.body)
            const formattedDate = new Date(post.data.pubDate).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })
            
            return (
              <a
                href={`/blog/${post.slug}`}
                class="blog-card opacity-0 translate-y-20 rounded-2xl overflow-hidden transition-all hover:scale-105 hover:shadow-2xl block cursor-pointer"
                data-tags={post.data.tags.join(',')}
                style="background-color: var(--surface); text-decoration: none;"
              >
                {/* Hero Image */}
                {post.data.heroImage ? (
                  <div class="relative h-48 overflow-hidden">
                    <img
                      src={post.data.heroImage}
                      alt={post.data.title}
                      class="w-full h-full object-cover"
                    />
                  </div>
                ) : (
                  <div class="relative h-48 overflow-hidden" style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));">
                    <div class="absolute inset-0 flex items-center justify-center">
                      <img
                        src={drawings.spiralsColorful.dark}
                        alt=""
                        class="w-32 h-32 object-contain opacity-30 only-dark"
                        aria-hidden="true"
                      />
                      <img
                        src={drawings.spiralsColorful.light}
                        alt=""
                        class="w-32 h-32 object-contain opacity-30 only-light"
                        aria-hidden="true"
                      />
                    </div>
                  </div>
                )}

                {/* Post Content */}
                <div class="p-6">
                  {/* Date and Reading Time */}
                  <div class="flex items-center gap-3 mb-3 text-xs" style="color: var(--muted);">
                    <time datetime={post.data.pubDate.toISOString()}>
                      {formattedDate}
                    </time>
                    <span>â€¢</span>
                    <span>{readingTime}</span>
                  </div>

                  <h3 class="text-xl font-bold mb-2" style="color: var(--text);">
                    {post.data.title}
                  </h3>

                  <p class="mb-4 text-sm" style="color: var(--muted);">
                    {post.data.description}
                  </p>

                  {/* Tags */}
                  {post.data.tags && post.data.tags.length > 0 && (
                    <div class="flex flex-wrap gap-2 mb-4">
                      {post.data.tags.slice(0, 3).map((tag) => (
                        <span class="text-xs px-2 py-1 rounded" style="background-color: var(--bg); color: var(--muted);">
                          {tag}
                        </span>
                      ))}
                    </div>
                  )}

                  {/* Read More */}
                  <span
                    class="inline-flex items-center gap-2 font-medium text-sm"
                    style="color: var(--accent-primary);"
                  >
                    Read More
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                  </span>
                </div>
              </a>
            )
          })}
        </div>
        
        {/* Empty State */}
        <div id="empty-state" class="hidden text-center py-16">
          <p class="text-xl" style="color: var(--muted);">No posts found with this tag.</p>
        </div>
      </div>
    </section>
    
  </main>
</Layout>

<!-- ============================================
     FILTERING & ANIMATION SCRIPT
     ============================================ -->
<script>
  import { gsap } from 'gsap'
  
  // Animate blog cards on load
  const cards = gsap.utils.toArray('.blog-card')
  cards.forEach((card, index) => {
    gsap.to(card as Element, {
      opacity: 1,
      y: 0,
      duration: 0.6,
      delay: index * 0.1,
      ease: 'power3.out'
    })
  })
  
  // Tag filtering functionality
  const tagFilters = document.querySelectorAll('.tag-filter')
  const blogCards = document.querySelectorAll('.blog-card')
  const emptyState = document.getElementById('empty-state')
  
  tagFilters.forEach(btn => {
    btn.addEventListener('click', () => {
      const selectedTag = btn.getAttribute('data-tag')
      
      // Update active button
      tagFilters.forEach(b => {
        const btnEl = b as HTMLElement
        btnEl.classList.remove('active')
        btnEl.style.backgroundColor = 'var(--bg)'
        btnEl.style.color = 'var(--text)'
      })
      const activeBtn = btn as HTMLElement
      activeBtn.classList.add('active')
      activeBtn.style.backgroundColor = 'var(--accent-primary)'
      activeBtn.style.color = 'white'
      
      // Filter posts
      let visibleCount = 0
      blogCards.forEach(card => {
        const cardTags = card.getAttribute('data-tags')?.split(',') || []
        
        if (selectedTag === 'all' || cardTags.includes(selectedTag as string)) {
          gsap.to(card, { opacity: 1, y: 0, duration: 0.4, display: 'block' })
          visibleCount++
        } else {
          gsap.to(card, { opacity: 0, y: 20, duration: 0.4, display: 'none' })
        }
      })
      
      // Show/hide empty state
      if (visibleCount === 0 && emptyState) {
        emptyState.classList.remove('hidden')
      } else if (emptyState) {
        emptyState.classList.add('hidden')
      }
    })
  })
</script>
